document.write('<!doctype html><html lang=en><meta charset=UTF-8><title>Synaptic Harmonics - Meat-based energy cell optimizer</title><meta content="width=device-width,initial-scale=1" name=viewport><link rel="shortcut icon" type=image/x-icon><style>:root{--color-white:#e7d9ff;--color-1:#e6c300;--color-2:#c431b3;--color-3:#8539ff;--color-4:#750062;--color-5:#4e0075;--color-6:#2d0cd3;--color-dark:#050031}#c2d,#plane{position:fixed;width:100vmin;aspect-ratio:1;max-width:900px;image-rendering:pixelated}body,html{margin:0;background-color:var(--color-dark);transition:background-color .1s;display:flex;justify-content:center;align-items:center;height:100%;width:100%;color:var(--color-white);font-family:Arial,Helvetica,sans-serif;overscroll-behavior:none;touch-action:none}*{user-select:none!important;-webkit-user-select:none!important}html{font-size:20px}@media (min-width:960px){html{font-size:35px}}.bck{position:fixed;height:200%;width:200%;background:url(wave.svg) center/200px;transform:rotate(-30deg)}h1,h2{font-size:2.5rem;animation:.8s linear infinite shadow;margin:.2rem}h2{font-size:1.3rem;font-weight:400}@keyframes shadow{from{text-shadow:0 0 var(--color-white),.05em .05em var(--color-2),.1em .1em var(--color-3),.2em .2em var(--color-6)}to{text-shadow:.05em .05em var(--color-2),.1em .1em var(--color-3),.2em .2em var(--color-6),.25em .25em transparent}}.hide{display:none!important}#intro,#lobby,#menu,#result{height:100%;width:100%;position:absolute;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:2vmax;box-sizing:border-box}#list{flex-direction:row;flex-wrap:wrap;gap:2vh;justify-content:center}#list button{height:80px;width:80px;display:flex;justify-content:center;align-items:center;font-size:1.2rem;padding:0}button:disabled{box-shadow:none;opacity:.7;border:none;cursor:default}ul{list-style:none;padding:0;text-align:center;display:flex;flex-direction:column;align-content:stretch}button{--button-color:var(--color-2);color:var(--color-dark);background-color:var(--color-white);padding:.5em 1em;margin:.5em 0;user-select:none;cursor:pointer;font-variant-caps:small-caps;font-weight:700;font-size:1em;box-shadow:5px 5px var(--button-color);border:3px solid var(--button-color);width:100%;display:inline-flex;justify-content:center;align-items:center;gap:1em;border-radius:99px}ul button :last-child{margin-left:auto}button:active{animation:.1s click}@keyframes click{from{transform:translate(0,0);box-shadow:5px 5px var(--button-color)}to{transform:translate(4px,4px);box-shadow:1px 1px var(--button-color)}}#closeBtn{position:fixed;top:1em;right:1em;padding:0;width:1.5em;height:1.5em;--button-color:transparent;background:#757575;box-shadow:none;mix-blend-mode:luminosity;mix-blend-mode:plus-lighter}ul button:hover{--button-color:var(--color-1)}#resultText{max-width:35ch}#intro{max-width:60ch}.text{text-align:justify;text-indent:2em;line-height:1.4;box-shadow:0 0 100px 50px #050031;background:var(--color-dark)}b{color:var(--color-1)}#controls{position:fixed;bottom:0;width:90%;text-align:center;margin:2vh 0;display:flex;justify-content:center;transform:translateY(calc(100% + 2vh));transition:.5s ease-in-out .1s;gap:4vh;flex-wrap:wrap}#controls.slide{transform:translateY(0)}#fps{position:fixed;top:0;left:0;color:var(--color-1);padding:1vh;font-size:10px}input[type=range]{--range-width:25px;-webkit-appearance:none;max-width:100%;width:400px;background:0 0}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{width:100%;height:var(--range-width);cursor:pointer;box-shadow:0 0 0 #000,0 0 0 #0d0d0d;background:var(--color-2);border-radius:99px;border:5px solid var(--color-dark)}input[type=range]::-webkit-slider-thumb{box-shadow:0 0 0 #000,0 0 0 #0d0d0d;border:0 solid #000;height:40px;width:40px;border-radius:40px;background:var(--color-dark);cursor:pointer;-webkit-appearance:none;margin-top:-12.5px}input[type=range]:focus::-webkit-slider-runnable-track{background:var(--color-2)}input[type=range]::-moz-range-track{width:100%;height:15px;cursor:pointer;box-shadow:0 0 0 #000,0 0 0 #0d0d0d;background:var(--color-2);border-radius:var(--range-width);border:5px solid var(--color-dark)}input[type=range]::-moz-range-thumb{box-shadow:0 0 0 #000,0 0 0 #0d0d0d;border:0 solid #000;height:40px;width:40px;border-radius:40px;background:var(--color-dark);cursor:pointer}.cre{--circle-rang-size:150px;--range-width:17px;height:var(--circle-rang-size);aspect-ratio:1;flex-shrink:0;padding:20px;margin:-20px;overscroll-behavior-block:none}#ring{pointer-events:none;height:100%;width:100%;border:var(--range-width) solid var(--color-2);box-sizing:border-box;border-radius:999px;position:relative}#ring::after,#ring::before{content:"";position:absolute;display:block;border-radius:999px;box-sizing:border-box}#ring::before{height:calc(100% + var(--range-width)*2 - 2px);aspect-ratio:1;margin:calc(-1 * var(--range-width) + 1px);box-shadow:0 0 0 4px var(--color-dark)}#ring::after{height:calc(100%);aspect-ratio:1;box-shadow:0 0 0 4px var(--color-dark)}#thumb{font-size:48px;height:1em;aspect-ratio:1;background:var(--color-dark);border-radius:99px;position:absolute;top:calc(50% - .5em);right:calc(-.5em - var(--range-width)/ 2)}#submit{--button-color:var(--color-dark);height:100px;width:100px;background:var(--color-1);font-size:30px;font-weight:700;transition:.1s ease-in-out 50ms;flex-shrink:0;margin:0}#submit.clicked{animation:.2s click}#lights{position:fixed;top:0;display:flex;transform:translateY(calc(-150% + 2vh));padding:3vh}#controls.slide+#lights{transform:translateY(0)}.led{--color-lights:#ffffff55;position:relative;height:15px;width:20px;background:var(--color-lights);margin:15px;box-shadow:0 0 5px 1px transparent}.led::after{content:"";height:6px;width:28px;position:absolute;background:var(--color-lights);bottom:-6px;left:-4px}.led::before{content:"";height:10px;width:20px;position:absolute;background:var(--color-lights);top:-10px;left:0;border-radius:99px 99px 0 0}.led,.led::after,.led::before{transition:background 50ms ease-in-out,box-shadow 50ms ease-in-out}.led.on{--color-lights:var(--color-white)}.led.on,.led.on::after,.led.on::before{box-shadow:0 0 5px 1px var(--color-white);transition:background 50ms ease-in-out 50ms,box-shadow 50ms ease-in-out 50ms}i{display:block;position:relative;top:20px}i::after,i::before{content:"";position:absolute;height:30px;width:20px;border:solid var(--color-dark);border-width:0 4px 4px 0;display:inline-block}i::before{left:-18px;border-radius:0 0 15px}i::after{right:-18px;border-width:0 0 4px 4px;border-radius:0 0 0 15px}#overlay{display:inline-flex;border-radius:999px;mix-blend-mode:hue;mix-blend-mode:plus-lighter;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:50vmin;aspect-ratio:1;max-width:400px;border:2vh solid var(--color-5)}#plane{display:flex;place-content:center;animation:1s ease-in-out infinite alternate bob}#plane svg{animation:1s ease-in-out -.5s infinite alternate rotate;position:relative;left:0;height:100%}#plane path{transform-origin:65% 44%;transition:transform .1s ease-in-out}@keyframes bob{from{transform:translate(-2%,-10%)}to{transform:translate(2%,0)}}@keyframes rotate{from{transform:rotate(0)}to{transform:rotate(10deg)}}#switches{display:flex;gap:1em;align-items:center;margin-right:1em}#switches button{font-size:25px;padding:0;width:60px;height:60px;border-radius:10px;--button-color:var(--color-dark);background:var(--color-2)}@media (max-height:800px){#c2d,#plane{margin-top:-10%}#overlay{margin-top:-5%}}</style><div class=bck></div><canvas height=1080 id=c2d width=1920></canvas><div id=plane class=hide><svg viewBox="0 0 26.5 26.5" xmlns=http://www.w3.org/2000/svg><path d="m16.925 11.839-6.534.652.77 1.08z" fill=#e7d9ff id=pl1 /><path d="m11.282 15.234-.122-1.662 5.765-1.733z" fill=#8539ff id=pl3 /><path d="m16.925 11.839-5.235 2.36 1.455 1.77z" fill=#e7d9ff id=pl2 /></svg></div><div id=lobby class=hide><h1>Levels</h1><ul id=list></ul></div><div id=menu><h1><span>Synaptic Harmonics</span></h1><h2>Meat-based energy cell optimizer</h2><ul><li><button id=start>Start</button><li><button id=contGame>Levels</button></ul></div><div id=intro class=hide><div class=text><p>Your meat-brained species excels at <b>pattern&nbsp;recognition</b>, albeit through instinct rather than understanding. This experiment aims to determine if human intuition can <b>optimize</b> our multi-dimensional quintessence-fused energy cells effectively.<p><b>Do not concern yourself</b> with the intricacies of our technology; your fleshy brain could not begin to comprehend. Focus on <b>instinctively</b> finding the most <b>harmonious</b> parameter configurations.</div><ul><li><button id=play>Uh, OK...</button></ul></div><div id=result class=hide><h1 id=resultTitle></h1><p id=resultText><ul><li><button id=nextLevel><span>Continue</span><span>&twoheadrightarrow;</span></button><li><button id=retry><span>Retry</span><span>&circlearrowleft;</span></button><li><button id=thanks>Return</button></ul></div><div id=controls><div id=switches><button id=switch1 type=checkbox>&#8801;</button> <button id=switch2 type=checkbox>&#8801;</button></div><input id=range max=100 min=0 type=range> <input id=range2 max=100 min=0 type=range class=hide><div id=circleRangeElement class="hide cre"><div id=ring><div id=thumb></div></div></div><div id=circleRangeElement2 class="hide cre"><div id=ring><div id=thumb></div></div></div><button id=submit>OK</button></div><div id=lights></div><div id=fps class=hide></div><div id=overlay class=hide></div><button id=closeBtn class=hide>&times;</button>');let style="";class StateMachine{constructor(a,...b){this.currentState=a;this.currentState.onEnter?.(...b)}setState(a,...b){this.currentState.onLeave?.();this.currentState=a;this.currentState.onEnter?.(...b)}getState(){return this.currentState}}let gameStateMachine;function createGameStateMachine(a,...b){gameStateMachine=new StateMachine(a,...b)}let TAU=2*Math.PI;
class CircleRange{constructor(a){this.previousAngle=this.value=this.turns=0;this.prevPos={x:0,y:0};this.multiplier=1;this.ringSize=0;a.addEventListener("pointerdown",b=>this.dragStart(b));this.inputHandler=b=>this.moveThumb(b);document.addEventListener("pointerup",()=>this.dragStop());this.input=a;this.ring=this.input.children[0];this.thumb=this.ring.children[0]}dragStart(a){this.previousAngle=this.calculateCircleAngle(a.x,a.y);document.addEventListener("pointermove",this.inputHandler)}dragStop(){document.removeEventListener("pointermove",
this.inputHandler)}moveThumb(a){a=this.calculateCircleAngle(a.x,a.y);let b=this.previousAngle-a;this.previousAngle=a;b>=Math.PI?this.turns++:b<=-Math.PI&&this.turns--;this.value-=Math.min(15,b);this.updateThumb()}updateThumb(){let {x:a,y:b}=this.angleToPos(this.ringSize,this.value);this.thumb.style.transform=`translate(${a-this.ringSize}px, ${b-this.ringSize/2}px)`}calculateCircleAngle(a,b){let {height:c,width:e,x:g,y:h}=this.input.getBoundingClientRect();return Math.atan2(b-(h+c/2),a-(g+e/2))}angleToPos(a,
b){return{x:a/2+a/2*Math.cos(b),y:a/2+a/2*Math.sin(b)}}toggle(a){this.value=0;this.updateThumb();this.input.classList.toggle("hide",!a);this.ringSize=this.input.children[0].clientHeight+15}getValue(){return this.multiplier*(this.turns+this.value/TAU)}}
class Controls{constructor(){this.isEscape=this.isConfirm=this.isRight=this.isLeft=this.isDown=this.isUp=!1;this.keyMap=new Map;this.previousState={isUp:this.isUp,isDown:this.isDown,isConfirm:this.isConfirm,isEscape:this.isEscape};document.addEventListener("keydown",a=>this.toggleKey(a,!0));document.addEventListener("keyup",a=>this.toggleKey(a,!1));this.inputDirection=new DOMPoint;closeBtn.addEventListener("click",()=>{gameStateMachine.setState(menuState)})}queryController(){this.previousState.isUp=
this.isUp;this.previousState.isDown=this.isDown;this.previousState.isConfirm=this.isConfirm;this.previousState.isEscape=this.isEscape;let a=navigator.getGamepads()[0],b=this.keyMap.get("KeyA")||this.keyMap.get("ArrowLeft")||a?.buttons[14].pressed?-1:0,c=this.keyMap.get("KeyD")||this.keyMap.get("ArrowRight")||a?.buttons[15].pressed?1:0,e=this.keyMap.get("KeyW")||this.keyMap.get("ArrowUp")||a?.buttons[12].pressed?-1:0,g=this.keyMap.get("KeyS")||this.keyMap.get("ArrowDown")||a?.buttons[13].pressed?1:
0;this.inputDirection.x=b+c||a?.axes[0]||0;this.inputDirection.y=e+g||a?.axes[1]||0;.1>Math.hypot(this.inputDirection.x,this.inputDirection.y)&&(this.inputDirection.x=0,this.inputDirection.y=0);this.isUp=0>this.inputDirection.y;this.isDown=0<this.inputDirection.y;this.isLeft=0>this.inputDirection.x;this.isRight=0<this.inputDirection.x;this.isConfirm=!!(this.keyMap.get("Enter")||a?.buttons[0].pressed||a?.buttons[9].pressed);(this.isEscape=!(!this.keyMap.get("Escape")&&!a?.buttons[8].pressed))&&gameStateMachine.setState(menuState)}toggleKey(a,
b){this.keyMap.set(a.code,b)}}let controls$1=new Controls,circleRange=new CircleRange(circleRangeElement),circleRange2=new CircleRange(circleRangeElement2);var bodyStyles=window.getComputedStyle(document.body);
let colorWhite=bodyStyles.getPropertyValue("--color-white"),color1=bodyStyles.getPropertyValue("--color-1"),color2=bodyStyles.getPropertyValue("--color-2"),color3=bodyStyles.getPropertyValue("--color-3"),color4=bodyStyles.getPropertyValue("--color-4"),color5=bodyStyles.getPropertyValue("--color-5"),color6=bodyStyles.getPropertyValue("--color-6"),colorDark=bodyStyles.getPropertyValue("--color-dark");function renderLeds(){for(let a=0;5>a;a++)lights.innerHTML+='<div class="led"><i/></div>'}
function cap(a){return.95<a?1:.05>a?0:a}function easeInOutSine(a){return cap(-(Math.cos(Math.PI*a)-1)/2)}function background(a){document.body.style.background=a}function exponencialSmoothing(a,b,c,e=3){return a+c*e/1E3*(b-a)}function minAngleDistanceWithin90(a,b){a=Math.abs((a+360)%360-(b+360)%360);180<a&&(a=360-a);90<a&&(a=90-a%90);45<a&&(a=45-a%45);return a}
class DrawEngine{constructor(){let a=()=>{c2d.height=c2d.clientHeight;c2d.width=c2d.clientWidth};window.addEventListener("resize",a);a();renderLeds()}}new DrawEngine;
let W={models:{},reset:a=>{W.canvas=a;W.objs=0;W.current={};W.next={};W.textures={};W.gl=a.getContext("webgl2");W.gl.blendFunc(770,771);W.gl.activeTexture(33984);W.program=W.gl.createProgram();W.gl.enable(2884);W.gl.shaderSource(a=W.gl.createShader(35633),"#version 300 es\n      precision highp float;\n      in vec4 pos, col, uv, normal;\n      uniform mat4 pv, eye, m, im;\n      uniform vec4 bb;\n      out vec4 v_pos, v_col, v_uv, v_normal;\n      void main() {                                 \n        gl_Position = pv * ( \n          v_pos = bb.z > 0.\n          ? m[3] + eye * (pos * bb)\n          : m * pos\n        );                                          \n        v_col = col;\n        v_uv = uv;\n        v_normal = transpose(inverse(m)) * normal;\n      }");W.gl.compileShader(a);
W.gl.attachShader(W.program,a);console.log("vertex shader:",W.gl.getShaderInfoLog(a)||"OK");W.gl.shaderSource(a=W.gl.createShader(35632),"#version 300 es\n      precision highp float;\n      in vec4 v_pos, v_col, v_uv, v_normal;\n      uniform vec3 light;\n      uniform vec4 o;\n      uniform sampler2D sampler;\n      out vec4 c;\n\n      void main() {\n        c = mix(texture(sampler, v_uv.xy), v_col, o[3]); \n        if(o[1] > 0.){ \n          c = vec4(\n            c.rgb * (max(0., dot(light, -normalize(\n              o[0] > 0.\n              ? vec3(v_normal.xyz)\n              : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz)) \n            )))\n            + o[2]), \n            c.a \n          );\n        }\n      }");
W.gl.compileShader(a);W.gl.attachShader(W.program,a);console.log("fragment shader:",W.gl.getShaderInfoLog(a)||"OK");W.gl.linkProgram(W.program);W.gl.useProgram(W.program);console.log("program:",W.gl.getProgramInfoLog(W.program)||"OK");W.gl.enable(2929);W.light({y:-1});W.camera({fov:30});setTimeout(W.draw,16)},setState:(a,b,c,e,g,h,l,m,k,d,p,n,u)=>{let q;(q=a).n||(q.n="o"+W.objs++);a.size&&(a.w=a.h=a.d=a.size);a.t&&a.t.width&&!W.textures[a.t.id]&&(c=W.gl.createTexture(),W.gl.pixelStorei(37441,!0),
W.gl.bindTexture(3553,c),W.gl.pixelStorei(37440,1),W.gl.texImage2D(3553,0,6408,6408,5121,a.t),W.gl.generateMipmap(3553),W.textures[a.t.id]=c);a.fov&&(W.projection=new DOMMatrix([1/Math.tan(a.fov*Math.PI/180)/(W.canvas.width/W.canvas.height),0,0,0,0,1/Math.tan(a.fov*Math.PI/180),0,0,0,0,-1001/999,-1,0,0,-2002/999,0]));a={type:b,...(W.current[a.n]=W.next[a.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0}),...a,f:0};W.models[a.type]?.vertices&&!W.models?.[a.type].verticesBuffer&&(W.gl.bindBuffer(34962,
W.models[a.type].verticesBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[a.type].vertices),35044),!W.models[a.type].normals&&W.smooth&&W.smooth(a),W.models[a.type].normals&&(W.gl.bindBuffer(34962,W.models[a.type].normalsBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[a.type].normals.flat()),35044)));W.models[a.type]?.uv&&!W.models[a.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[a.type].uvBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[a.type].uv),
35044));W.models[a.type]?.indices&&!W.models[a.type].indicesBuffer&&(W.gl.bindBuffer(34963,W.models[a.type].indicesBuffer=W.gl.createBuffer()),W.gl.bufferData(34963,new Uint16Array(W.models[a.type].indices),35044));a.t?a.t&&!a.mix&&(a.mix=0):a.mix=1;W.next[a.n]=a},draw:(a,b,c,e,g=[])=>{if(W.isDrawing)console.log("drop frame");else{W.isDrawing=!0;b=a-W.lastFrame;W.lastFrame=a;requestAnimationFrame(W.draw);W.next?.camera?.g&&W.render(W.next[W.next.camera.g],b,1);c=W.animation("camera");W.next?.camera?.g&&
c.preMultiplySelf(W.next[W.next.camera.g].M||W.next[W.next.camera.g].m);W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"eye"),!1,c.toFloat32Array());c.invertSelf();c.preMultiplySelf(W.projection);W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"pv"),!1,c.toFloat32Array());W.gl.clear(16640);for(e in W.next)W.next[e].t||1!=W.col(W.next[e].b)[3]?g.push(W.next[e]):W.render(W.next[e],b);g.sort((h,l)=>W.dist(l)-W.dist(h));W.gl.enable(3042);for(e of g)["plane","billboard"].includes(e.type)&&
W.gl.depthMask(0),W.render(e,b),W.gl.depthMask(1);W.gl.disable(3042);W.gl.uniform3f(W.gl.getUniformLocation(W.program,"light"),W.lerp("light","x"),W.lerp("light","y"),W.lerp("light","z"));W.isDrawing=!1}},render:(a,b,c=["camera","light","group"].includes(a.type),e)=>{a.t&&(W.gl.bindTexture(3553,W.textures[a.t.id]),W.gl.uniform1i(W.gl.getUniformLocation(W.program,"sampler"),0));a.f<a.a&&(a.f+=b);a.f>a.a&&(a.f=a.a);W.next[a.n].m=W.animation(a.n);W.next[a.g]&&W.next[a.n].m.preMultiplySelf(W.next[a.g].M||
W.next[a.g].m);W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"m"),!1,(W.next[a.n].M||W.next[a.n].m).toFloat32Array());W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"im"),!1,(new DOMMatrix(W.next[a.n].M||W.next[a.n].m)).invertSelf().toFloat32Array());if(!c)if(W.models[a.type])W.gl.bindBuffer(34962,W.models[a.type].verticesBuffer),W.gl.vertexAttribPointer(e=W.gl.getAttribLocation(W.program,"pos"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(e),W.models[a.type].uvBuffer&&(W.gl.bindBuffer(34962,
W.models[a.type].uvBuffer),W.gl.vertexAttribPointer(e=W.gl.getAttribLocation(W.program,"uv"),2,5126,!1,0,0),W.gl.enableVertexAttribArray(e)),(a.s||W.models[a.type].customNormals)&&W.models[a.type].normalsBuffer&&(W.gl.bindBuffer(34962,W.models[a.type].normalsBuffer),W.gl.vertexAttribPointer(e=W.gl.getAttribLocation(W.program,"normal"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(e)),W.gl.uniform4f(W.gl.getUniformLocation(W.program,"o"),a.s,(3<a.mode||3<W.gl[a.mode])&&!a.ns?1:0,W.ambientLight||.2,a.mix),
W.gl.uniform4f(W.gl.getUniformLocation(W.program,"bb"),a.w,a.h,"billboard"==a.type,0),W.models[a.type].indicesBuffer&&W.gl.bindBuffer(34963,W.models[a.type].indicesBuffer),W.gl.vertexAttrib4fv(W.gl.getAttribLocation(W.program,"col"),W.col(a.b)),W.models[a.type].indicesBuffer?W.gl.drawElements(+a.mode||W.gl[a.mode],W.models[a.type].indices.length,5123,0):W.gl.drawArrays(+a.mode||W.gl[a.mode],0,W.models[a.type].vertices.length/3);else{console.error(`Render error. Model for object type "${a.type}" not found`);
debugger}},lerp:(a,b)=>W.next[a]?.a?W.current[a][b]+W.next[a].f/W.next[a].a*(W.next[a][b]-W.current[a][b]):W.next[a][b],animation:(a,b=new DOMMatrix)=>W.next[a]?b.translateSelf(W.lerp(a,"x"),W.lerp(a,"y"),W.lerp(a,"z")).rotateSelf(W.lerp(a,"rx"),W.lerp(a,"ry"),W.lerp(a,"rz")).scaleSelf(W.lerp(a,"w"),W.lerp(a,"h"),W.lerp(a,"d")):b,dist:(a,b=W.next.camera)=>a?.m&&b?.m?(b.m.m41-a.m.m41)**2+(b.m.m42-a.m.m42)**2+(b.m.m43-a.m.m43)**2:0,ambient:a=>W.ambientLight=a,col:a=>[...a.replace("#","").match(5>a.length?
/./g:/../g).map(b=>("0x"+b)/(5>a.length?15:255)),1],add:(a,b)=>{W.models[a]=b;b.normals&&(W.models[a].customNormals=1);W[a]=c=>W.setState(c,a)},group:a=>W.setState(a,"group"),move:(a,b)=>setTimeout(()=>{W.setState(a)},b||1),delete:(a,b)=>setTimeout(()=>{delete W.next[a]},b||1),camera:(a,b)=>setTimeout(()=>{W.setState(a,a.n="camera")},b||1),light:(a,b)=>b?setTimeout(()=>{W.setState(a,a.n="light")},b):W.setState(a,a.n="light"),smooth:(a,b={},c=[],e,g,h,l,m,k,d,p,n,u,q)=>{W.models[a.type].normals=[];
for(h=0;h<W.models[a.type].vertices.length;h+=3)c.push(W.models[a.type].vertices.slice(h,h+3));(e=W.models[a.type].indices)?g=1:(e=c,g=0);for(h=0;h<2*e.length;h+=3){l=h%e.length;m=c[p=g?W.models[a.type].indices[l]:l];k=c[n=g?W.models[a.type].indices[l+1]:l+1];d=c[u=g?W.models[a.type].indices[l+2]:l+2];let r=[k[0]-m[0],k[1]-m[1],k[2]-m[2]],t=[d[0]-k[0],d[1]-k[1],d[2]-k[2]];q=h>l?[0,0,0]:[r[1]*t[2]-r[2]*t[1],r[2]*t[0]-r[0]*t[2],r[0]*t[1]-r[1]*t[0]];let x,y;(x=b)[y=m[0]+"_"+m[1]+"_"+m[2]]||(x[y]=[0,
0,0]);let z,A;(z=b)[A=k[0]+"_"+k[1]+"_"+k[2]]||(z[A]=[0,0,0]);let B,C;(B=b)[C=d[0]+"_"+d[1]+"_"+d[2]]||(B[C]=[0,0,0]);W.models[a.type].normals[p]=b[m[0]+"_"+m[1]+"_"+m[2]]=b[m[0]+"_"+m[1]+"_"+m[2]].map((v,w)=>v+q[w]);W.models[a.type].normals[n]=b[k[0]+"_"+k[1]+"_"+k[2]]=b[k[0]+"_"+k[1]+"_"+k[2]].map((v,w)=>v+q[w]);W.models[a.type].normals[u]=b[d[0]+"_"+d[1]+"_"+d[2]]=b[d[0]+"_"+d[1]+"_"+d[2]].map((v,w)=>v+q[w])}}};
W.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]});
W.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,
0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]});W.cube=a=>W.setState(a,"cube");W.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]});
((a,b,c,e,g,h,l=[],m=[],k=[],d=8)=>{for(c=0;c<=d;c++)for(e=c*Math.PI/d,a=0;a<=d;a++)b=2*a*Math.PI/d,l.push(+(Math.sin(b)*Math.sin(e)/2).toFixed(6),+(Math.cos(e)/2).toFixed(6),+(Math.cos(b)*Math.sin(e)/2).toFixed(6)),k.push(3.5*Math.sin(a/d),-Math.sin(c/d)),a<d&&c<d&&m.push(g=c*(d+1)+a,h=g+(d+1),g+1,g+1,h,h+1);W.add("sphere",{vertices:l,uv:k,indices:m})})();
((a,b,c,e,g,h,l=[],m=[],k=[],d=20)=>{e=.2*d;let p=.8*d;for(c=0;c<=d;c++){a=c<=e;b=c>=p;let n=a?c/e*.5:b?0:.5,u=a?.5:b?-.5:2*((d-c)/d-.5);for(a=0;a<=d;a++)b=2*a*Math.PI/d,l.push(+(Math.sin(b)*n).toFixed(6),u,+(Math.cos(b)*n).toFixed(6)),k.push(3.5*Math.sin(a/d),-Math.sin(c/d)),a<d&&c<d&&m.push(g=c*(d+1)+a,h=g+(d+1),g+1,g+1,h,h+1)}W.add("cylinder",{vertices:l,uv:k,indices:m})})();
((a,b,c,e,g,h,l=[],m=[],k=[],d=20)=>{for(c=0;c<=d;c++){e=0==c||c==d?0:.5;let p=(d-(0==c?c+1:c==d?c-1:c))/d-.5;for(a=0;a<=d;a++){b=2*a*Math.PI/d;let n=3*Math.PI*p;l.push((Math.sin(b)*e+Math.cos(n)).toFixed(6),p-.05*e*Math.sin(b+n+Math.PI/2),(Math.cos(b)*e+Math.sin(n)).toFixed(6));k.push(3.5*Math.sin(a/d),-Math.sin(c/d));a<d&&c<d&&m.push(g=c*(d+1)+a,h=g+(d+1),g+1,g+1,h,h+1)}}W.add("helix",{vertices:l,uv:k,indices:m})})();
let melodies=[[6,5,3,3,5,5,0,5,-2,0,-2,0,6,3,2,3],[4,3,5,4,3,5,6,4,3,5,4,3,5,6,4,3],[3,2,3,6,0,-2,0,-2,5,0,5,5,3,3,5,6]],baseTracks=[[2,3,2.5,4],[4,3.5,3,2.5],[4,2.5,3,2]],f=(a,b)=>c=>Math.sin(60*Math.pow(10,-(c+1)/2048%8))/8+Math.tan(Math.cbrt(Math.sin(c*a[c>>13&15]/30)))/[2,3,4,6,8,12,16,24][c/[1,1.5][c>>12&1]>>10&7]/32+Math.cbrt(Math.asin(Math.sin(c/b[c>>16&3]/10)))/64,SAMPLE_RATE=32E3;
class BytebeatPlayer{constructor(){this.source=null;this.buffers=[];this.ctx=new AudioContext;this.createBuffers()}createBuffers(){for(let a=0;a<levels.length;a++){let b=melodies[a%melodies.length],c=baseTracks[a%melodies.length],e=(b.length+.4)*SAMPLE_RATE/2,g=this.ctx.createBuffer(1,e,SAMPLE_RATE),h=g.getChannelData(0);for(let l=0;l<e;l++)h[l]=f(b,c)(l);this.buffers.push(g)}}start(){this.ctx=new AudioContext;this.source=this.ctx.createBufferSource();this.source.buffer=this.buffers[gameData.level];
this.source.connect(this.ctx.destination);this.source.loop=!0;this.source.start()}stop(){this?.source?.stop()}}
let player,initAudio=()=>{player=new BytebeatPlayer},startAudio=()=>{setTimeout(()=>{player.start()},100)},stopAudio=()=>{player&&player.stop()},results={perfect:{pass:!0,title:"Perfect!",text:"I'm making a note here: huge success!"},great:{pass:!0,title:"Good job",text:"These results are very promising."},bad:{pass:!1,title:"Disappointing",text:"These results are not satisfactory. Try again."},end:{pass:!0,title:"End of experiment",text:"You have demonstrated promising results for your species. We will keep in touch."}};
class ResultState{constructor(){this.text=this.title="";this.pass=!0;nextLevel.addEventListener("click",()=>{let a=gameData.nextLevel();a?gameStateMachine.setState(a):this.setEnd();gameData.level++;gameData.storeLevel()});retry.addEventListener("click",()=>{let a=gameData.getLevel();a&&gameStateMachine.setState(a)});thanks.addEventListener("click",()=>{gameStateMachine.setState(menuState)})}onEnter(){background(colorDark);W.reset(c2d);thanks.classList.add("hide");result.classList.remove("hide");nextLevel.classList.toggle("hide",
!this.pass)}onLeave(){result.classList.add("hide")}onUpdate(){}setEnd(){this.setResult(results.end);thanks.classList.remove("hide");nextLevel.classList.add("hide");retry.classList.add("hide");stopAudio()}setResult(a){this.title=a.title;this.text=a.text;this.pass=a.pass;resultTitle.innerText=this.title;resultText.innerText=this.text}}let resultState=new ResultState;function newResultState(a){resultState.setResult(5<a?results.perfect:4.5<a?results.great:results.bad);return resultState}
function updateLeds(a){for(let b=0;5>b;b++)lights.children[b].classList.toggle("on",a>=b+1)}
class Level{constructor(){this.score=0;this.inputListener=()=>this.updateRange();this.submitListener=()=>this.submit()}hide(){[range2,circleRangeElement,switches,overlay,plane].map(a=>a.classList.add("hide"))}onEnter(){stopAudio();startAudio();background(gameData.color());range.addEventListener("input",this.inputListener);range2.addEventListener("input",this.inputListener);submit.addEventListener("click",this.submitListener);controls.classList.add("slide");this.hide()}onLeave(){range.removeEventListener("input",
this.inputListener);range2.removeEventListener("input",this.inputListener);submit.removeEventListener("click",this.submitListener);controls.classList.remove("slide");submit.classList.remove("clicked");range.step="1";range2.step="1";this.hide();updateLeds(0)}calculatePower(a){this.score=5*a+.25;updateLeds(Math.floor(this.score))}submit(){submit.removeEventListener("submit",this.inputListener);submit.classList.add("clicked");setTimeout(()=>{gameStateMachine.setState(newResultState(this.score))},500)}updateRange(){}}
class TwoGearsLevel extends Level{constructor(){super(...arguments);this.angle2=this.angle1=this.timeG2=this.timeG1=0;this.speed=-.5;this.counter=0;this.targetSpeed=1;this.interval=5E3}onEnter(){super.onEnter();range.value="50";range.step="10";this.updateRange();W.reset(c2d);W.camera({y:.7,z:7,rx:-7,fov:10});W.light({x:1,y:-5,z:-1});W.ambient(.5);W.group({n:"G1",ry:0});W.cube({g:"G1",w:.5,h:1,d:1,x:-.25,y:0,b:colorDark});W.group({n:"G2",ry:0});W.cube({g:"G2",w:.5,h:1,d:1,x:.25,y:0,b:colorWhite})}onUpdate(a){this.timeG1+=
a;this.timeG1>this.interval&&(this.timeG1-=this.interval);this.angle1=360*this.timeG1/this.interval;W.move({n:"G1",rx:this.angle1,ry:45});this.timeG2+=a*this.speed;this.timeG2>this.interval?this.timeG2-=this.interval:0>this.timeG2&&(this.timeG2+=this.interval);this.angle2=360*this.timeG2/this.interval;W.move({n:"G2",rx:this.angle2,ry:45});this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}updateRange(){this.speed=((parseInt(range.value)||0)-50)/40}calculatePower(){super.calculatePower(Math.pow((1-
Math.abs(this.targetSpeed-this.speed))*(1-Math.abs(this.angle1%90-this.angle2%90)/90),3))}}let twoGearsLevel=new TwoGearsLevel;
class HelixLevel extends Level{constructor(){super(...arguments);this.time2=this.time1=this.counter=0;this.interval=2E3;this.speed=1.5;this.angleOffset=180;this.ry2=this.ry1=0}onEnter(){super.onEnter();W.reset(c2d);range.classList.add("hide");circleRange.toggle(!0);circleRange2.toggle(!0);W.camera({x:0,y:0,z:1.8,rz:45});W.ambient(1);W.helix({n:"H1",w:.1,d:.1,h:1,ns:1,b:colorDark});W.helix({n:"H2",w:.1,d:.1,h:1,ns:1,b:colorWhite})}onLeave(){range.classList.remove("hide");circleRange.toggle(!1);circleRange2.toggle(!1);
super.onLeave()}onUpdate(a){this.time1+=a;this.time1>this.interval&&(this.time1-=this.interval);this.time2+=this.speed*a;this.time2>this.interval?this.time2-=this.interval:0>this.time2&&(this.time2+=this.interval);this.ry1=360*this.time1/this.interval;W.helix({n:"H1",ry:this.ry1});this.ry2=360*this.time2/this.interval-this.angleOffset;W.helix({n:"H2",x:.01,z:.01,ry:this.ry2-180});this.counter++;20<this.counter&&(this.counter=0,this.calculatePower());this.updateRange()}updateRange(){this.angleOffset=
360*circleRange.getValue();this.speed=3*(circleRange2.getValue()-.5);this.speed=Math.round(5*this.speed)/5}calculatePower(){super.calculatePower(Math.max(0,1-Math.abs(this.speed-1))*(1-Math.abs(this.ry1-this.ry2+360)%360/360))}}let helixLevel=new HelixLevel,HEIGHT=.3,WIDTH=.2;
class DockLevel extends Level{constructor(){super(...arguments);this.numObjects=12;this.radius=.9;this.maxFrames=2E4;this.radiusOffset=this.counter=this.frame=0;this.objectArc=360/this.numObjects;this.expectedRadius=.8;this.expectedAngle=360/this.numObjects}onEnter(){super.onEnter();range.value="0";circleRange.toggle(!0);circleRange.multiplier=8;this.updateRange();W.reset(c2d);W.camera({y:1,z:1.8,rx:-45,fov:38});for(let a=0;a<this.numObjects;a++)W.group({n:`GG${a}`}),W.group({g:`GG${a}`,n:`G${a}`}),
W.pyramid({g:`G${a}`,n:`P${a}`,ns:1,w:WIDTH,h:HEIGHT,d:WIDTH,b:a%2?colorDark:colorWhite})}updateObjects(){for(let a=0;a<this.numObjects;a+=2){let b=360*(1/this.numObjects*a+this.frame/this.maxFrames),c=8*b;W.move({n:`GG${a}`,ry:b});W.move({n:`G${a}`,rx:c,z:this.radius});W.move({n:`P${a}`,y:HEIGHT/2});W.move({n:`GG${a+1}`,ry:b+circleRange.getValue()-this.expectedAngle});W.move({n:`G${a+1}`,rx:c+180,z:this.radius-this.radiusOffset});W.move({n:`P${a+1}`,y:HEIGHT/2})}}onUpdate(a){this.frame+=a;this.frame>=
this.maxFrames&&(this.frame-=this.maxFrames);this.updateObjects();this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}updateRange(){this.radiusOffset=this.expectedRadius-parseInt(range.value)/100}calculatePower(){let a=1-Math.abs(this.radiusOffset),b=Math.max(0,1-Math.abs(this.expectedAngle-circleRange.getValue()));super.calculatePower((b+a)/2)}}let dockLevel=new DockLevel;
class MetronomeLevel extends Level{constructor(){super(...arguments);this.interval=1E3;this.amplitudeRange=1.5;this.time=0;this.amplitudeG1=1;this.score=this.counter=this.amplitudeG2=0}onEnter(){super.onEnter();range.value="0";this.updateRange();W.reset(c2d);W.camera({y:.5,z:7,rx:-7,fov:10});W.group({n:"G1",ry:0});W.cube({g:"G1",w:.1,h:1,d:.1,x:0,y:.5,ns:1,b:colorDark});W.group({n:"G2",ry:0});W.cube({g:"G2",w:.1,h:1,d:.1,x:0,y:.5,ns:1,b:colorWhite})}onUpdate(a){this.time+=a;this.time>this.interval&&
(this.time-=this.interval);a=30*Math.cos(2*Math.PI*this.time/this.interval);W.move({n:"G1",x:-.5,y:-.5,rz:this.amplitudeG1*a});W.move({n:"G2",x:.5,y:-.5,rz:this.amplitudeG2*a});this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}updateRange(){this.amplitudeG2=this.amplitudeRange*parseInt(range.value)/100}calculatePower(){super.calculatePower(1-Math.abs(this.amplitudeG1-this.amplitudeG2))}}let metronomeLevel=new MetronomeLevel;
class CylinderLevel extends Level{constructor(){super(...arguments);this.ry=this.targetRy=this.rx=this.targetRx=this.frame=0}onEnter(){super.onEnter();range.value="75";range2.value="95";range2.classList.remove("hide");overlay.classList.remove("hide");this.updateRange();W.reset(c2d);W.camera({y:0,z:2,fov:30});W.light({x:0,y:0,z:-1});W.group({n:"G1",ry:0});W.cylinder({g:"G1",n:"C1",w:.7,h:1.8,d:.7,x:0,y:0,rx:45,ns:1,b:color1})}onUpdate(a){W.move({n:"G1",rz:this.frame++});let b=parseInt(range.value)-
10,c=parseInt(range2.value)+10;this.targetRx=90-90*b/100;this.targetRy=90-90*c/100;this.rx=exponencialSmoothing(this.rx,this.targetRx,a,10);this.ry=exponencialSmoothing(this.ry,this.targetRy,a,10);W.move({n:"C1",rx:this.rx,ry:this.ry});this.calculatePower()}calculatePower(){super.calculatePower((1-10*Math.abs(90-this.targetRx)/360+(1-10*Math.abs(this.targetRy)/360))/2)}}let cylinderLevel=new CylinderLevel;
class TwoCubesLevel extends Level{constructor(){super();this.interval=8E3;this.angle2=this.angle1=this.timeG2=this.timeG1=0;this.speed=-.5;this.score=this.counter=0;this.targetSpeed=1}onEnter(){super.onEnter();range.value="45";this.updateRange();W.reset(c2d);W.camera({y:4,z:7,rx:-30,fov:10});W.light({x:0,y:-5,z:0});W.ambient(.8);W.group({n:"G1",ry:0});W.cube({g:"G1",w:1.5,h:1,d:1,x:0,y:0,b:colorWhite});W.group({n:"G2",ry:0});W.cube({g:"G2",w:1.5,h:1,d:1,x:0,y:0,b:colorWhite})}onLeave(){super.onLeave();
document.removeEventListener("input",this.inputListener);controls.classList.remove("slide")}onUpdate(a){this.timeG1+=a;this.timeG1>this.interval&&(this.timeG1-=this.interval);this.angle1=this.timeG1/this.interval*360;W.move({n:"G1",ry:this.angle1});this.timeG2+=a*this.speed;this.timeG2>this.interval?this.timeG2-=this.interval:0>this.timeG2&&(this.timeG2+=this.interval);this.angle2=this.timeG2/this.interval*360;W.move({n:"G2",ry:this.angle2});this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}updateRange(){this.speed=
2*(range.value-50)/100}calculatePower(){this.score=Math.pow((1-Math.abs(this.targetSpeed-this.speed))*(1-Math.abs(this.angle1%180-this.angle2%180)/180),3);super.calculatePower(this.score)}}let twoCubesLevel=new TwoCubesLevel,A1=90,A2=210,MAX_RANGE=4;
class FlyLevel extends Level{constructor(){super(...arguments);this.counter=this.frame=0;this.targetAngle1=this.angle1=A1;this.targetAngle2=this.angle2=A2}onEnter(){super.onEnter();c2d.classList.add("hide");plane.classList.remove("hide");range2.classList.remove("hide");this.updateRange();range.value="50";range2.value="50";this.updateAngles()}onLeave(){c2d.classList.remove("hide");super.onLeave()}onUpdate(a){this.targetAngle1=MAX_RANGE*(parseInt(range.value)-50)+A1;this.targetAngle2=MAX_RANGE*(parseInt(range2.value)-
50)+A2;this.angle1=exponencialSmoothing(this.angle1,this.targetAngle1,a);this.angle2=exponencialSmoothing(this.angle2,this.targetAngle2,a);this.updateAngles();this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}calculatePower(){super.calculatePower(Math.pow(1-(Math.abs(this.angle1/400)+Math.abs((360-this.angle2)/400)),5))}updateAngles(){pl1.style.transform=`rotate(${this.angle1}deg)`;pl2.style.transform=`rotate(${this.angle2}deg)`}}let flyLevel=new FlyLevel;
class CircleLevel extends Level{constructor(){super(...arguments);this.count=8;this.time=0;this.maxTime=5E3;this.size=.1;this.counter=0;this.animationScale=1;this.offset=0}onEnter(){super.onEnter();range.value="75";range2.value="25";this.updateRange();range2.classList.remove("hide");overlay.classList.remove("hide");W.reset(c2d);W.camera({y:0,z:2,fov:30});for(let a=0;a<this.count;a++)W.group({n:`G${a}`,rz:180*a/this.count}),W.sphere({g:`G${a}`,n:`N${a}`,w:this.size,h:this.size,d:this.size,x:0,y:.5,
ns:1,b:[colorWhite,color1,color2,color3][a%4]})}easeInOutSine(a){return-(Math.cos(Math.PI*this.animationScale*a)-1)/2}updateObjects(){for(let a=0;a<this.count;a++){let b=this.offset+this.easeInOutSine(a/this.count+2*this.time/this.maxTime)-.5;W.move({n:`N${a}`,y:b})}}onUpdate(a){this.time+=a;this.time>=this.maxTime/this.animationScale&&(this.time-=this.maxTime/this.animationScale);this.updateObjects();this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}updateRange(){this.animationScale=
(3*parseInt(range.value)+25)/100;this.offset=.4*parseInt(range2.value)/100-.2}calculatePower(){super.calculatePower((1-Math.abs(1-this.animationScale))*(1-Math.abs(4*this.offset)))}}let circleLevel=new CircleLevel;
class SwitchLevel extends Level{constructor(){super();this.counter=0;this.interval=5E3;this.previous=0;this.progress=this.selected=1;this.sizes=[0,1,0];this.angles=[.8,.16,.24];this.states=[1,1,1];this.changeSelected=()=>{1<=this.progress&&(this.previous=this.selected,this.selected=(this.selected+1)%3,this.progress=0)};this.toggleMovement=()=>{this.states[this.selected]=1-this.states[this.selected]}}onEnter(){this.sizes=[0,1,0];this.angles=[.8,.16,.24];this.states=[1,1,1];super.onEnter();range.classList.add("hide");
switches.classList.remove("hide");this.updateRange();switch1.addEventListener("click",this.changeSelected);switch2.addEventListener("click",this.toggleMovement);W.reset(c2d);W.camera({x:-1.5,y:1.8,z:1.5,rx:-45,ry:-45});W.light({x:1,y:-5,z:-1});W.ambient(.1);W.cube({n:"G1",w:.33,h:1,d:1,x:-.33,y:0,b:colorWhite});W.cube({n:"G2",w:.33,h:1,d:1,x:0,y:0,b:colorDark});W.cube({n:"G3",w:.33,h:1,d:1,x:.33,y:0,b:colorWhite})}onLeave(){super.onLeave();range.classList.remove("hide");switches.classList.add("hide")}onUpdate(a){if(1>
this.progress){this.progress+=a/200;for(var b=0;b<this.sizes.length;b++)this.selected===b?this.sizes[b]=easeInOutSine(this.progress):this.previous===b&&(this.sizes[b]=easeInOutSine(1-this.progress))}for(b=0;3>b;b++)this.angles[b]+=this.states[b]*a/this.interval,W.move({n:`G${b+1}`,rx:360*this.angles[b],b:this.selected===b?colorDark:colorWhite});this.counter++;20<this.counter&&(this.counter=0,this.calculatePower())}calculatePower(){let a=minAngleDistanceWithin90(360*this.angles[0],360*this.angles[1])/
90,b=minAngleDistanceWithin90(360*this.angles[1],360*this.angles[2])/90;console.log(a,b);super.calculatePower(Math.pow(1-(a+b)/2,4))}}let switchLevel=new SwitchLevel;
class Metronome2Level extends Level{constructor(){super();this.time=0;this.interval=1E3;this.counter=this.interval2=this.time2=this.buttonTime2=this.buttonTime1=0;this.onButton1=()=>{this.interval2=0;this.buttonTime1=Date.now();this.buttonTime2&&(this.interval2=40*Math.round(Math.abs(this.buttonTime1-this.buttonTime2)/20),console.log(this.interval2),this.time2=this.time,this.buttonTime2=this.buttonTime1=0)};this.onButton2=()=>{this.interval2=0;this.buttonTime2=Date.now();this.buttonTime1&&(this.interval2=
40*Math.round(Math.abs(this.buttonTime1-this.buttonTime2)/20),console.log(this.interval2),this.time2=this.time,this.buttonTime2=this.buttonTime1=0)}}onEnter(){super.onEnter();range.classList.add("hide");switches.classList.remove("hide");W.reset(c2d);W.camera({y:.5,z:7,rx:-7,fov:10});switch1.addEventListener("click",this.onButton1);switch2.addEventListener("click",this.onButton2);W.group({n:"G1",ry:0});W.cube({g:"G1",w:.1,h:1,d:.1,x:0,y:.5,ns:1,b:colorDark});W.group({n:"G2",ry:0});W.cube({g:"G2",w:.1,
h:1,d:.1,x:0,y:.5,ns:1,b:colorWhite})}onLeave(){super.onLeave();range.classList.remove("hide");switches.classList.add("hide")}onUpdate(a){this.time+=a;this.time>this.interval&&(this.time-=this.interval);this.time2+=a;this.time2>this.interval2&&(this.time2-=this.interval2);a=30*Math.cos(2*Math.PI*this.time/this.interval);W.move({n:"G1",x:-.5,y:-.5,rz:a});a=30*Math.cos(2*Math.PI*(this.interval2?this.time2/this.interval2:this.buttonTime1?0:this.buttonTime2?.5:.25));W.move({n:"G2",x:.5,y:-.5,rz:a});this.counter++;
20<this.counter&&(this.counter=0,this.calculatePower())}calculatePower(){super.calculatePower(Math.pow(1-Math.abs(this.interval-this.interval2)/1E3,3))}}let metronome2Level=new Metronome2Level,levels=[metronomeLevel,twoCubesLevel,dockLevel,twoGearsLevel,cylinderLevel,flyLevel,circleLevel,switchLevel,helixLevel,metronome2Level],levelColors=[color6,color5,color4];function getStorage(){var a=localStorage.getItem("meat_brain_cell_optimizer__level")||"";a=parseInt(a);return a<=levels.length?a:0}
class GameData{constructor(){this.maxLevel=this.level=0;this.maxLevel=getStorage()}getLevel(){return levels[this.level]}nextLevel(){return levels[this.level+1]}prevLevel(){return levels[this.level-1]}storeLevel(){let a=getStorage();(!a||a<this.level)&&localStorage.setItem("meat_brain_cell_optimizer__level",`${this.level}`)}color(){return levelColors[this.level%levelColors.length]}}let gameData=new GameData;class GameState{onEnter(){gameStateMachine.setState(gameData.getLevel())}onUpdate(){}}
let gameState=new GameState;class IntroState{onEnter(){background(colorDark);intro.classList.remove("hide");play.addEventListener("click",this.startGame)}onLeave(){intro.classList.add("hide");play.removeEventListener("click",this.startGame)}onUpdate(){this.updateControls()}updateControls(){controls$1.isConfirm&&!controls$1.previousState.isConfirm&&this.startGame()}startGame(){gameStateMachine.setState(gameState)}}let introState=new IntroState;
class LevelListState{constructor(){lobby.addEventListener("click",a=>{"submit"===a?.target?.type&&(a=parseInt(a.target.innerText)-1,gameData.level=a,this.startGame())})}onEnter(){background(colorDark);list.innerHTML="";for(let a=0;a<levels.length;a++)list.innerHTML+=`<button ${gameData.maxLevel<a?'disabled="disabled"':""}">${a+1}</button>`;lobby.classList.remove("hide")}onLeave(){lobby.classList.add("hide");play.removeEventListener("click",this.startGame)}onUpdate(){}startGame(){gameStateMachine.setState(gameState)}}
let levelListState=new LevelListState;
class MenuState{constructor(){this.selectedButton=0;this.buttons=[this.startGame,this.continueGame]}onEnter(){stopAudio();background(colorDark);W.reset(c2d);closeBtn.classList.add("hide");menu.classList.remove("hide");start.addEventListener("click",this.startGame);contGame.addEventListener("click",this.continueGame)}onLeave(){closeBtn.classList.remove("hide");menu.classList.add("hide");start.removeEventListener("click",this.startGame);contGame.removeEventListener("click",this.continueGame)}onUpdate(){this.updateControls()}updateControls(){controls$1.isUp&&
!controls$1.previousState.isUp&&(this.selectedButton--,0>this.selectedButton&&(this.selectedButton=this.buttons.length-1));controls$1.isDown&&!controls$1.previousState.isDown&&(this.selectedButton++,this.selectedButton>=this.buttons.length&&(this.selectedButton=0));if(controls$1.isConfirm&&!controls$1.previousState.isConfirm){let a=this.buttons[this.selectedButton];a&&a()}}startGame(){gameData.level=0;setTimeout(()=>{gameStateMachine.setState(introState)},100)}continueGame(){setTimeout(()=>{gameStateMachine.setState(levelListState)},
100)}}let menuState=new MenuState;document.querySelector('link[type="image/x-icon"]').href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E\ud83d\udd35%3C/text%3E%3C/svg%3E";createGameStateMachine(menuState);let previousTime=0,fpsBacklog=[];initAudio();
(function draw(a){let c=a-previousTime;previousTime=a;controls$1.queryController();gameStateMachine.getState().onUpdate(c);fpsBacklog.push(1E3/c);15===fpsBacklog.length&&(fps.innerHTML=`${Math.round(fpsBacklog.reduce((e,g)=>e+g)/15)} FPS`,fpsBacklog=[]);requestAnimationFrame(draw)})(0);